app-template:
  controllers:
    main:
      initContainers:
        setup:
          image:
            repository: alpine/git
            tag: latest
          command:
            - /bin/sh
            - -c
          args:
            - |
              git clone https://github.com/spliit-app/spliit /setup-data
              cp -r /setup-data/* /app/
          volumeMounts:
            - name: app-data
              mountPath: /app
      containers:
        main:
          image:
            repository: node
            tag: 18-alpine
          command:
            - /bin/sh
            - -c
          args:
            - |
              cd /app
              npm install
              npm run build
              npm start
          env:
            NODE_ENV: production
            DATA_DIRECTORY: /storage
          securityContext:
            allowPrivilegeEscalation: false
          volumeMounts:
            - name: app-data
              mountPath: /app
            - name: storage
              mountPath: /storage
      volumes:
        - name: app-data
          emptyDir: {}
  service:
    main:
      ports:
        http:
          port: 5000
          protocol: HTTP
  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        external-dns.alpha.kubernetes.io/target: "homelab-tunnel.epx.pub"
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
      hosts:
        - host: &host spliit.epx.pub
          paths:
            - path: /
              pathType: Prefix
              service:
                name: main
                port: http
      tls:
        - hosts:
            - *host
          secretName: spliit-tls-certificate
  persistence:
    storage:
      enabled: true
      accessMode: ReadWriteOnce
      size: 1Gi
      globalMounts:
        - path: /storage
